import pytest
import responses
from scripts.scuttle import _ensure_safe_url, ScuttleError, WebScuttler

def test_ssrf_direct_block():
    """Prove we block direct local IPs."""
    with pytest.raises(ScuttleError, match="Blocked host"):
        _ensure_safe_url("http://127.0.0.1/admin")
    with pytest.raises(ScuttleError, match="Blocked host"):
        _ensure_safe_url("http://192.168.1.1/setup")

@responses.activate
def test_ssrf_redirect_bypass_exploit():
    """
    EXPLOIT: Prove we can bypass the check using a redirect.
    Currently, _ensure_safe_url is only called on the initial URL.
    """
    # The initial URL is safe
    initial_url = "http://safe-site.com/redirect"
    # The target is unsafe
    target_url = "http://127.0.0.1/private-data"
    
    responses.add(
        responses.GET,
        initial_url,
        status=302,
        headers={"Location": target_url}
    )
    responses.add(
        responses.GET,
        target_url,
        json={"secret": "this-should-not-be-accessible"},
        status=200
    )
    
    scuttler = WebScuttler()
    # If this SUCCEEDS, it means we have a vulnerability because we reached 127.0.0.1
    # We WANT this test to FAIL (i.e. raise ScuttleError) after we harden the code.
    with pytest.raises(ScuttleError, match="Blocked host"):
        scuttler.scuttle(initial_url)
    
    print("\n[âœ”] SSRF Redirect Exploit Blocked Successfully.")

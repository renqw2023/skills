<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EngineMind EFT - Emotional Framework Translator</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Inter:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#09090b;--bg2:#111113;--bg3:#18181b;--bg4:#27272a;--text:#fafafa;--text2:#a1a1aa;--text3:#71717a;--accent:#6366f1;--border:#27272a;--green:#22c55e;--red:#ef4444;--amber:#f59e0b;--blue:#3b82f6}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.header{background:var(--bg2);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between}
.header h1{font-size:16px;font-weight:600;color:var(--text);letter-spacing:-0.3px}
.header h1 span{color:var(--accent);font-weight:400}
.header-right{display:flex;align-items:center;gap:12px}
.stat-pill{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:11px;color:var(--text2);font-family:'JetBrains Mono'}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);display:inline-block;margin-right:4px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.main{display:grid;grid-template-columns:1fr 340px;min-height:calc(100vh - 50px)}
.left{padding:16px 20px;overflow-y:auto;max-height:calc(100vh - 50px)}
.right{background:var(--bg2);border-left:1px solid var(--border);padding:16px;overflow-y:auto;max-height:calc(100vh - 50px)}
.section-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;font-weight:600}
/* Log entries */
.log-entry{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px 16px;margin-bottom:8px;cursor:pointer;transition:all .15s}
.log-entry:hover{border-color:var(--text3)}
.log-entry.selected{border-color:var(--accent);background:var(--bg3)}
.log-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.log-emotion{font-size:14px;font-weight:600;letter-spacing:-0.3px}
.log-conf{font-size:11px;color:var(--text3);font-family:'JetBrains Mono'}
.log-time{font-size:10px;color:var(--text3);font-family:'JetBrains Mono'}
.log-preview{font-size:12px;color:var(--text2);line-height:1.5;margin-bottom:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.log-tags{display:flex;gap:4px;flex-wrap:wrap}
.tag{font-size:9px;padding:2px 6px;border-radius:4px;font-family:'JetBrains Mono';font-weight:500}
.log-metrics{display:flex;gap:8px;margin-top:6px;font-size:10px;color:var(--text3);font-family:'JetBrains Mono'}
/* Sentences in log */
.sent-row{display:flex;align-items:flex-start;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
.sent-row:last-child{border-bottom:none}
.sent-tag{min-width:90px;font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;text-align:center;flex-shrink:0}
.sent-text{color:var(--text2);line-height:1.5;flex:1}
.sent-text.is-peak{color:var(--text);font-weight:500}
.sent-conf{font-size:10px;color:var(--text3);font-family:'JetBrains Mono';min-width:30px;text-align:right}
/* Right panel */
.detail-hero{text-align:center;padding:16px 0;margin-bottom:16px;border-bottom:1px solid var(--border)}
.detail-hero .emo{font-size:24px;font-weight:700;letter-spacing:-0.5px}
.detail-hero .sub{font-size:11px;color:var(--text3);margin-top:4px}
.detail-hero .desc{font-size:11px;color:var(--text2);margin-top:6px;font-style:italic}
.why-list{margin-bottom:16px}
.why-item{font-size:11px;color:var(--text2);padding:3px 0;padding-left:12px;position:relative;line-height:1.5}
.why-item::before{content:"//";position:absolute;left:0;color:var(--text3);font-family:'JetBrains Mono';font-size:10px}
.gauge-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:16px}
.gauge{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:8px}
.gauge .gl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px}
.gauge .gv{font-size:16px;font-weight:600;font-family:'JetBrains Mono';margin:2px 0}
.gauge .gb{height:2px;background:var(--bg4);border-radius:1px}
.gauge .gf{height:100%;border-radius:1px}
.dim-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px}
.dim-row .dn{width:80px;color:var(--text3);text-align:right;font-size:10px}
.dim-row .db{flex:1;height:4px;background:var(--bg4);border-radius:2px;overflow:hidden}
.dim-row .df{height:100%;border-radius:2px}
.dim-row .dv{width:28px;color:var(--text2);font-family:'JetBrains Mono';font-size:10px}
.score-row{display:flex;align-items:center;gap:4px;margin-bottom:3px;font-size:10px}
.score-row .sn{width:90px;font-weight:500}
.score-row .sb{flex:1;height:3px;background:var(--bg4);border-radius:2px;overflow:hidden}
.score-row .sf{height:100%;border-radius:2px}
.score-row .sv{width:28px;text-align:right;font-family:'JetBrains Mono';color:var(--text3)}
.process-row{display:flex;justify-content:space-between;padding:3px 0;font-size:11px;border-bottom:1px solid var(--border)}
.process-row .pk{color:var(--text3)}
.process-row .pv{color:var(--text2);font-family:'JetBrains Mono'}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--text3)}
.empty p{margin-top:8px;font-size:13px}
.empty .hint{font-size:11px;margin-top:4px}
.refresh-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;font-family:'JetBrains Mono'}
.refresh-btn:hover{border-color:var(--text3)}
@media(max-width:900px){.main{grid-template-columns:1fr}.right{border-left:none;border-top:1px solid var(--border)}}
</style>
</head>
<body>
<div class="header">
  <h1>EngineMind <span>EFT</span> &mdash; Emotional Framework Translator</h1>
  <div class="header-right">
    <span class="stat-pill" id="statPill">0 analyses</span>
    <button class="refresh-btn" onclick="load()">Refresh</button>
    <span class="stat-pill"><span class="live-dot"></span>Connected</span>
  </div>
</div>
<div class="main">
  <div class="left">
    <div class="section-label">Analysis Log</div>
    <div id="logList">
      <div class="empty" id="emptyState">
        <p>Waiting for agent responses...</p>
        <p class="hint">The EFT hook captures each response automatically.</p>
      </div>
    </div>
  </div>
  <div class="right">
    <div class="section-label">Response Detail</div>
    <div id="detailPanel">
      <div class="empty"><p>Select an entry from the log</p></div>
    </div>
  </div>
</div>
<script>
const COLORS={ANGER:"#E53E3E",FEAR:"#9F7AEA",FASCINATION:"#4299E1",DETERMINATION:"#ED8936",JOY:"#48BB78",SADNESS:"#718096",SURPRISE:"#ECC94B",EMPATHY:"#ED64A6",VULNERABILITY:"#B794F4",NEUTRAL:"#A0AEC0"};
let entries=[], selected=null;

async function load(){
  try{
    // Try gateway API first, fallback to standalone
    let url = "/eft/api/history";
    let r = await fetch(url).catch(()=>null);
    if(!r||!r.ok) { r = await fetch("http://localhost:8889/api/history").catch(()=>null); }
    if(!r||!r.ok){
      // Try loading from log file via standalone server
      document.getElementById('statPill').textContent='API unavailable';
      return;
    }
    const data=await r.json();
    entries=data.entries||[];
    document.getElementById('statPill').textContent=`${data.count} analyses`;
    renderLog();
    if(entries.length>0 && !selected) selectEntry(0);
  }catch(e){console.error(e)}
}

function renderLog(){
  const el=document.getElementById('logList');
  if(!entries.length){el.innerHTML='<div class="empty"><p>Waiting for agent responses...</p><p class="hint">The EFT hook captures each response automatically.</p></div>';return;}
  el.innerHTML='';
  entries.forEach((e,i)=>{
    const c=e.color||COLORS[e.emotion]||'#71717a';
    const t=new Date(e.ts);
    const time=t.toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const d=document.createElement('div');
    d.className='log-entry'+(selected===i?' selected':'');
    d.onclick=()=>selectEntry(i);
    d.innerHTML=`
      <div class="log-top">
        <span class="log-emotion" style="color:${c}">${e.emotion}</span>
        <span class="log-time">${time}</span>
      </div>
      <div class="log-preview">${esc(e.textPreview||'')}</div>
      <div class="log-tags">
        <span class="tag" style="background:${c}22;color:${c}">${(e.confidence*100).toFixed(0)}% conf</span>
        <span class="tag" style="background:var(--bg4);color:var(--text3)">arc: ${e.arc||'?'}</span>
        ${e.process?.latencyMs?`<span class="tag" style="background:var(--bg4);color:var(--text3)">${e.process.latencyMs}ms</span>`:''}
        ${e.process?.totalTokens?`<span class="tag" style="background:var(--bg4);color:var(--text3)">${e.process.totalTokens} tok</span>`:''}
      </div>
      <div class="log-metrics">
        <span>phi=${e.metrics?.phi?.toFixed(3)||'?'}</span>
        <span>nc=${e.metrics?.nc?.toFixed(3)||'?'}</span>
        <span>ma=${e.metrics?.ma?.toFixed(3)||'?'}</span>
        <span>${e.analysisMs||'?'}ms</span>
      </div>`;
    el.appendChild(d);
  });
}

function selectEntry(i){
  selected=i;
  renderLog();
  const e=entries[i];
  if(!e)return;
  const c=e.color||COLORS[e.emotion]||'#71717a';
  const dp=document.getElementById('detailPanel');
  let html=`
    <div class="detail-hero">
      <div class="emo" style="color:${c}">${e.emotion}</div>
      <div class="sub">Confidence: ${(e.confidence*100).toFixed(0)}% &middot; Secondary: ${e.secondary||'?'} (${((e.sec_conf||0)*100).toFixed(0)}%)</div>
      <div class="desc">${esc(e.desc||'')}</div>
    </div>
    <div class="section-label">Why This Emotion</div>
    <div class="why-list">${(e.why||[]).map(w=>`<div class="why-item">${esc(w)}</div>`).join('')}</div>
    <div class="section-label">Peak Segment</div>
    <div style="background:var(--bg3);border-left:3px solid ${c};padding:10px 12px;border-radius:4px;margin-bottom:16px">
      <div style="font-size:12px;color:var(--text);line-height:1.6">"${esc(e.peak?.text||'')}"</div>
      <div style="font-size:10px;color:var(--text3);margin-top:4px">${e.peak?.emotion||''} &middot; ${((e.peak?.confidence||0)*100).toFixed(0)}%</div>
    </div>
    <div class="section-label">Sentence Breakdown</div>
    <div style="margin-bottom:16px">${(e.sentences||[]).map((s,j)=>{
      const sc=s.color||COLORS[s.emotion]||'#71717a';
      const isPeak=j===e.peak?.idx;
      return `<div class="sent-row">
        <span class="sent-tag" style="background:${sc}15;color:${sc};border:1px solid ${sc}30">${s.emotion}</span>
        <span class="sent-text${isPeak?' is-peak':''}">${esc(s.text)}</span>
        <span class="sent-conf">${(s.confidence*100).toFixed(0)}%</span>
      </div>`;
    }).join('')}</div>
    <div class="section-label">Instruments</div>
    <div class="gauge-grid">
      ${gauge('PHI','Integration',e.metrics?.phi,'#6366f1')}
      ${gauge('NC','Narrative',e.metrics?.nc,'#3b82f6')}
      ${gauge('MA','Awareness',e.metrics?.ma,'#22c55e')}
      ${gauge('CL','Level',e.metrics?.cl,'#f59e0b',0.3)}
      ${gauge('Arousal','Energy',e.metrics?.arousal,'#ef4444')}
      ${gauge('Pressure','Tension',e.metrics?.pressure,'#eab308',0.2)}
    </div>
    <div class="section-label">Dimensional Profile</div>
    <div style="margin-bottom:16px">${Object.entries(e.dim_profile||{}).sort((a,b)=>b[1]-a[1]).map(([k,v])=>{
      const mx=Math.max(...Object.values(e.dim_profile||{}),1);
      return `<div class="dim-row"><span class="dn">${k}</span><div class="db"><div class="df" style="width:${(v/mx*100)}%;background:${c}"></div></div><span class="dv">${Math.round(v)}</span></div>`;
    }).join('')}</div>
    <div class="section-label">Emotion Scores</div>
    <div style="margin-bottom:16px">${Object.entries(e.scores||{}).sort((a,b)=>b[1]-a[1]).map(([k,v])=>{
      const kc=COLORS[k]||'#666';
      return `<div class="score-row"><span class="sn" style="color:${kc}">${k}</span><div class="sb"><div class="sf" style="width:${v*100}%;background:${kc}"></div></div><span class="sv">${(v*100).toFixed(0)}%</span></div>`;
    }).join('')}</div>
    <div class="section-label">Process Metrics</div>
    <div style="margin-bottom:16px">
      ${prow('Model',e.process?.model)}
      ${prow('Latency',e.process?.latencyMs?e.process.latencyMs+'ms':'?')}
      ${prow('Input Tokens',e.process?.inputTokens||'?')}
      ${prow('Output Tokens',e.process?.outputTokens||'?')}
      ${prow('Token Ratio',e.process?.tokenRatio||'?')}
      ${prow('Tool Calls',e.process?.toolCalls||0)}
      ${prow('Analysis Time',e.analysisMs?e.analysisMs+'ms':'?')}
      ${prow('Sentences',e.n||'?')}
      ${prow('Arc Type',e.arc||'?')}
    </div>`;
  dp.innerHTML=html;
}

function gauge(label,sub,val,color,max){
  max=max||1;
  const v=val??0;
  const pct=Math.min(v/max*100,100);
  return `<div class="gauge"><div class="gl">${label} <span style="color:var(--text3);font-weight:300">${sub}</span></div><div class="gv" style="color:${color}">${typeof v==='number'?v.toFixed(v<1?3:2):'?'}</div><div class="gb"><div class="gf" style="width:${pct}%;background:${color}"></div></div></div>`;
}
function prow(k,v){return `<div class="process-row"><span class="pk">${k}</span><span class="pv">${v??'?'}</span></div>`;}
function esc(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

load();
setInterval(load, 10000);
</script>
</body>
</html>
